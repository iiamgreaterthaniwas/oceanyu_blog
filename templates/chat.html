{% extends 'base_no_search.html' %}
{% block title %}与 {{ friend.username }} 聊天 - CRAZYBLOG{% endblock %}

{% block content %}
<div class="chat-page">
  <!-- 聊天顶栏 -->
  <div class="chat-topbar">
    <a href="{{ url_for('messages_list') }}" class="chat-back">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
    </a>
    <div class="chat-friend-info">
      <div class="chat-friend-avatar">
        {% if friend.avatar_path %}
        <img src="/static/{{ friend.avatar_path }}" alt="头像">
        {% else %}
        <span>{{ friend.username[0] }}</span>
        {% endif %}
      </div>
      <span class="chat-friend-name">{{ friend.username }}</span>
    </div>
    <a href="{{ url_for('user_profile', user_id=friend.id) }}" class="chat-more">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg>
    </a>
  </div>

  <!-- 消息区域 -->
  <div class="chat-messages" id="chatMessages">
    {% for msg in messages %}
    <div class="msg-row {% if msg.sender_id == current_user.id %}msg-me{% else %}msg-other{% endif %}" data-msg-id="{{ msg.id }}">
      {% if msg.sender_id != current_user.id %}
      <div class="msg-avatar">
        {% if friend.avatar_path %}
        <img src="/static/{{ friend.avatar_path }}" alt="头像">
        {% else %}
        <span>{{ friend.username[0] }}</span>
        {% endif %}
      </div>
      {% endif %}
      <div class="msg-bubble-wrap">
        <div class="msg-time">{{ msg.created_at.strftime('%H:%M') }}</div>
        <div class="msg-bubble">
          {% if msg.image_path %}
          <div class="msg-img-wrap">
            <img src="/static/{{ msg.thumb_path or msg.image_path }}" alt="图片" class="msg-img"
                 onclick="openImageViewer('/static/{{ msg.image_path }}', '/static/{{ msg.thumb_path or msg.image_path }}')" loading="lazy">
          </div>
          {% endif %}
          {% if msg.content %}
          <p class="msg-text">{{ msg.content }}</p>
          {% endif %}
        </div>
        <button class="msg-delete-btn" onclick="deleteMessage({{ msg.id }}, this)">删除</button>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- 输入区 -->
  <div class="chat-input-bar">
    <label class="img-upload-btn" title="发送图片">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="previewImage(this)">
    </label>
    <div class="input-preview-wrap" id="inputPreviewWrap" style="display:none">
      <img id="inputPreview" src="" alt="预览">
      <button onclick="clearImagePreview()" class="clear-preview">✕</button>
    </div>
    <textarea id="msgInput" class="msg-textarea" placeholder="发送消息..." rows="1"
              oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
    <button class="send-btn" onclick="sendMessage()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<!-- 图片查看器 -->
<div id="imageViewer" class="image-viewer" style="display:none" onclick="closeImageViewer()">
  <div class="viewer-controls" onclick="event.stopPropagation()">
    <a id="viewerDownloadOrig" href="#" download class="viewer-btn">⬇ 下载原图</a>
    <button onclick="closeImageViewer()" class="viewer-close">✕</button>
  </div>
  <img id="viewerImg" src="" alt="查看图片" onclick="event.stopPropagation()">
</div>

<style>
.chat-page {
  display: flex; flex-direction: column;
  height: calc(100vh - 64px);
  max-width: 760px; margin: 0 auto;
  padding-bottom: 0;
}

/* 顶栏 */
.chat-topbar {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,182,193,0.2);
  border-radius: 16px 16px 0 0;
  position: sticky; top: 0; z-index: 10;
}
.chat-back { color: #ff9eb5; display: flex; align-items: center; text-decoration: none; }
.chat-friend-info { flex: 1; display: flex; align-items: center; gap: 10px; }
.chat-friend-avatar { width: 38px; height: 38px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg,#ffb6c1,#ff9eb5); display:flex;align-items:center;justify-content:center; flex-shrink:0; }
.chat-friend-avatar img { width:100%;height:100%;object-fit:cover; }
.chat-friend-avatar span { color:white;font-weight:bold; }
.chat-friend-name { font-weight: 600; font-size: 1rem; color: #333; }
.chat-more { color: #bbb; display: flex; align-items: center; text-decoration: none; }

/* 消息区 */
.chat-messages {
  flex: 1; overflow-y: auto;
  padding: 16px 12px;
  display: flex; flex-direction: column; gap: 12px;
  background: linear-gradient(180deg, rgba(255,240,245,0.5) 0%, rgba(255,255,255,0.7) 100%);
}

.msg-row { display: flex; align-items: flex-end; gap: 8px; }
.msg-me { flex-direction: row-reverse; }
.msg-other { flex-direction: row; }

.msg-avatar { width: 34px; height: 34px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg,#ffb6c1,#ff9eb5); display:flex;align-items:center;justify-content:center; flex-shrink:0; }
.msg-avatar img { width:100%;height:100%;object-fit:cover; }
.msg-avatar span { color:white;font-size:0.85rem;font-weight:bold; }

.msg-bubble-wrap {
  display: flex;
  flex-direction: column;
  max-width: 70%;
  gap: 3px;
}
.msg-me .msg-bubble-wrap { align-items: flex-end; }
.msg-other .msg-bubble-wrap { align-items: flex-start; }

.msg-time { font-size: 0.7rem; color: #ccc; }
.msg-bubble {
  padding: 10px 14px;
  border-radius: 18px;
  word-break: break-word;
  white-space: normal;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  max-width: 100%;
  min-width: 60px;
}
.msg-me .msg-bubble { background: linear-gradient(135deg,#ffb6c1,#ff8fab); color: white; border-bottom-right-radius: 4px; }
.msg-other .msg-bubble { background: white; color: #333; border-bottom-left-radius: 4px; }
.msg-text {
  margin: 0;
  font-size: 0.92rem;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  display: inline-block;
  max-width: 100%;
}

.msg-img-wrap {
  margin: 2px 0;
  max-width: 100%;
}
.msg-img {
  max-width: 220px;
  max-height: 220px;
  width: auto;
  height: auto;
  border-radius: 12px;
  cursor: pointer;
  display: block;
  object-fit: cover;
}

/* 删除按钮 */
.msg-delete-btn {
  display: none; background: none; border: none; font-size: 0.7rem;
  color: #ccc; cursor: pointer; padding: 2px 6px;
  border-radius: 8px; transition: color 0.2s;
}
.msg-bubble-wrap:hover .msg-delete-btn { display: block; }
.msg-delete-btn:hover { color: #ff4d6d; }

/* 输入区 */
.chat-input-bar {
  display: flex; align-items: flex-end; gap: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid rgba(255,182,193,0.2);
  border-radius: 0 0 16px 16px;
}
.img-upload-btn { color: #ffb6c1; cursor: pointer; display: flex; align-items: center; padding: 8px; border-radius: 50%; transition: background 0.2s; flex-shrink:0; }
.img-upload-btn:hover { background: rgba(255,182,193,0.1); }

.input-preview-wrap { position: relative; flex-shrink: 0; }
.input-preview-wrap img { width: 52px; height: 52px; object-fit: cover; border-radius: 10px; border: 2px solid rgba(255,182,193,0.5); }
.clear-preview { position: absolute; top: -6px; right: -6px; background: #ff4d6d; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 0.65rem; cursor: pointer; display:flex;align-items:center;justify-content:center; }

.msg-textarea {
  flex: 1; resize: none; border: none; outline: none;
  background: rgba(255,240,245,0.5);
  border-radius: 20px;
  padding: 10px 16px;
  font-size: 0.92rem;
  font-family: inherit;
  max-height: 120px;
  line-height: 1.5;
}

.send-btn {
  background: linear-gradient(135deg,#ffb6c1,#ff8fab);
  border: none; border-radius: 50%;
  width: 42px; height: 42px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: white; flex-shrink:0;
  box-shadow: 0 4px 12px rgba(255,182,193,0.4);
  transition: transform 0.15s, box-shadow 0.15s;
}
.send-btn:hover { transform: scale(1.08); }
.send-btn:active { transform: scale(0.95); }

/* 图片查看器 */
.image-viewer {
  position: fixed; inset: 0; background: rgba(0,0,0,0.9);
  z-index: 2000; display: flex; align-items: center; justify-content: center;
}
.image-viewer img { max-width: 95vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }
.viewer-controls {
  position: absolute; top: 16px; right: 16px;
  display: flex; gap: 10px; align-items: center;
}
.viewer-btn { color: white; background: rgba(255,255,255,0.15); border-radius: 20px; padding: 6px 14px; text-decoration: none; font-size: 0.85rem; }
.viewer-close { background: rgba(255,255,255,0.15); color: white; border: none; border-radius: 50%; width: 34px; height: 34px; cursor: pointer; font-size: 1.1rem; }
@media (max-width: 768px) {
    .main-content {
        margin-top: 70px !important;  /* 覆盖base中的值 */
    }
    
    .chat-page {
        height: calc(100vh - 70px - 64px);  /* 调整聊天页面的高度计算 */
    }
}
@media (max-width: 768px) {
  .chat-page { height: calc(100vh - 120px); }
  .msg-bubble-wrap { max-width: 82%; }
}
</style>

<script>
const currentUserId = {{ current_user.id }};
const friendId = {{ friend.id }};
let lastMsgId = {{ messages[-1].id if messages else 0 }};
let selectedFile = null;

// 滚动到底部
function scrollToBottom() {
  const el = document.getElementById('chatMessages');
  el.scrollTop = el.scrollHeight;
}
scrollToBottom();

// 自动高度
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// 回车发送（Shift+Enter换行）
function handleEnter(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// 预览图片
function previewImage(input) {
  if (!input.files || !input.files[0]) return;
  selectedFile = input.files[0];
  const url = URL.createObjectURL(selectedFile);
  document.getElementById('inputPreview').src = url;
  document.getElementById('inputPreviewWrap').style.display = 'block';
}

function clearImagePreview() {
  selectedFile = null;
  document.getElementById('imgInput').value = '';
  document.getElementById('inputPreviewWrap').style.display = 'none';
}

// 发送消息
async function sendMessage() {
  const content = document.getElementById('msgInput').value.trim();
  if (!content && !selectedFile) return;

  const fd = new FormData();
  fd.append('receiver_id', friendId);
  if (content) fd.append('content', content);
  if (selectedFile) fd.append('image', selectedFile);

  // 乐观更新
  document.getElementById('msgInput').value = '';
  clearImagePreview();

  try {
    const resp = await fetch('/send_message', { method: 'POST', body: fd });
    const data = await resp.json();
    if (data.success) {
      appendMessage(data.message, true);
      lastMsgId = data.message.id;
      scrollToBottom();
    }
  } catch (e) { console.error(e); }
}

// 渲染一条消息
function appendMessage(msg, isMe) {
  const container = document.getElementById('chatMessages');
  const row = document.createElement('div');
  row.className = `msg-row ${isMe ? 'msg-me' : 'msg-other'}`;
  row.dataset.msgId = msg.id;

  let avatarHtml = '';
  if (!isMe) {
    avatarHtml = `<div class="msg-avatar">${friendAvatarHtml}</div>`;
  }

  let bubbleContent = '';
  if (msg.image_thumb) {
    bubbleContent += `<div class="msg-img-wrap"><img src="${msg.image_thumb}" class="msg-img" loading="lazy" onclick="openImageViewer('${msg.image_orig}','${msg.image_thumb}')"></div>`;
  }
  if (msg.content) {
    bubbleContent += `<p class="msg-text">${escapeHtml(msg.content)}</p>`;
  }

  row.innerHTML = `
    ${avatarHtml}
    <div class="msg-bubble-wrap">
      <div class="msg-time">${msg.created_at}</div>
      <div class="msg-bubble">${bubbleContent}</div>
      <button class="msg-delete-btn" onclick="deleteMessage(${msg.id}, this)">删除</button>
    </div>
  `;
  container.appendChild(row);
}

// 简单的HTML转义函数，防止XSS
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// 好友头像 HTML（注入）
const friendAvatarHtml = `{% if friend.avatar_path %}<img src="/static/{{ friend.avatar_path }}" alt="">{% else %}<span>{{ friend.username[0] }}</span>{% endif %}`;

// 删除消息
async function deleteMessage(msgId, btn) {
  if (!confirm('确认删除这条消息？')) return;
  const resp = await fetch(`/delete_message/${msgId}`, { method: 'POST' });
  const data = await resp.json();
  if (data.success) {
    const row = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (row) row.remove();
  }
}

// 轮询新消息
async function pollMessages() {
  try {
    const resp = await fetch(`/poll_messages/${friendId}?after_id=${lastMsgId}`);
    const data = await resp.json();
    if (data.messages && data.messages.length > 0) {
      const wasAtBottom = isAtBottom();
      data.messages.forEach(msg => {
        if (msg.sender_id !== currentUserId) {
          appendMessage(msg, false);
          lastMsgId = msg.id;
        } else {
          lastMsgId = Math.max(lastMsgId, msg.id);
        }
      });
      if (wasAtBottom) scrollToBottom();
    }
  } catch (e) {}
}

function isAtBottom() {
  const el = document.getElementById('chatMessages');
  return el.scrollHeight - el.scrollTop - el.clientHeight < 60;
}

setInterval(pollMessages, 3000);

// 图片查看器
function openImageViewer(origSrc, thumbSrc) {
  document.getElementById('viewerImg').src = thumbSrc;
  document.getElementById('viewerDownloadOrig').href = origSrc;
  document.getElementById('imageViewer').style.display = 'flex';
}
function closeImageViewer() {
  document.getElementById('imageViewer').style.display = 'none';
}
</script>
{% endblock %}