{# ä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™ JS #}
{% if current_user and current_user.avatar_path %}
<script>
    window._userAvatarPath = "/{{ current_user.avatar_path }}";
    window._userName = "{{ current_user.username | e }}";
</script>
{% else %}
<script>
    window._userAvatarPath = null;
    window._userName = "è®¿å®¢";
</script>
{% endif %}

<!-- ========== æ‚¬æµ®æŒ‰é’® FAB ========== -->
<button class="chat-fab" id="chatFab" title="å’Œ AI èŠå¤©">
    <!-- æ—‹è½¬180Â°çš„å¤´åƒç”»å¸ƒ -->
    <canvas id="chatFabCanvas" width="62" height="62" style="display:none; border-radius:50%;"></canvas>
    <!-- åŠ è½½ä¸­çš„ç²‰è‰²é»˜è®¤å›¾æ ‡ -->
    <span class="chat-fab-icon loading-spinner"></span>
</button>

<!-- ========== èŠå¤©çª—å£ ========== -->
<div class="chat-window" id="chatWindow">

    <!-- çª—å£å¤´éƒ¨ -->
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="chat-header-avatar" id="chatHeaderAvatar">
                <!-- æ—‹è½¬180Â°çš„å¤´åƒç”± JS æ’å…¥ canvas -->
                <span class="chat-header-avatar-fallback">âœ¨</span>
            </div>
            <div class="chat-header-info">
                <span class="chat-header-name" id="chatHeaderName">AI å°åŠ©æ‰‹</span>
                <span class="chat-header-status" id="chatStatus">
                    <span class="status-dot"></span> åœ¨çº¿
                </span>
            </div>
        </div>
        <div class="chat-header-actions">
            <button class="chat-action-btn" onclick="clearAndResetChat()" title="æ¸…ç©ºå¯¹è¯">ğŸ—‘ï¸</button>
            <button class="chat-action-btn" onclick="toggleChatWindow()" title="å…³é—­">âœ•</button>
        </div>
    </div>

    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div class="chat-messages" id="chatMessages"></div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input-area">
        <div class="chat-input-wrapper">
            <textarea
                id="chatInput"
                class="chat-input"
                placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€..."
                rows="1"
                onkeydown="handleChatKeydown(event)"
                oninput="autoResizeChatInput(this)"
            ></textarea>
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- é®ç½©å±‚ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
<div class="chat-overlay" id="chatOverlay" onclick="toggleChatWindow()"></div>

<script>
(function () {
    // =============================================
    //  å…¨å±€çŠ¶æ€
    // =============================================
    let chatOpen          = false;
    let chatLoading       = false;
    let chatConversationId = null;

    const userName    = window._userName    || 'è®¿å®¢';
    const avatarPath  = window._userAvatarPath || null;

    // AI åç§°
    const aiName = userName + 'ï¼ˆç›—orå€’ç‰ˆï¼‰';

    // =============================================
    //  æ—‹è½¬180Â°å¤„ç†
    // =============================================
    function rotateImage(srcUrl, canvasEl, callback) {
        const dpr = window.devicePixelRatio || 1;
        const displayW = canvasEl.width;   // CSS æ˜¾ç¤ºå°ºå¯¸ï¼ˆç”±è°ƒç”¨æ–¹è®¾ç½®ï¼‰
        const displayH = canvasEl.height;

        // æŠŠ canvas å®é™…åƒç´ æ”¾å¤§ä¸º dpr å€ï¼ŒCSS å°ºå¯¸ä¿æŒä¸å˜ï¼Œæ¶ˆé™¤æ¨¡ç³Š
        canvasEl.width  = displayW * dpr;
        canvasEl.height = displayH * dpr;
        canvasEl.style.width  = displayW + 'px';
        canvasEl.style.height = displayH + 'px';

        const ctx = canvasEl.getContext('2d');
        ctx.scale(dpr, dpr);

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function () {
            ctx.clearRect(0, 0, displayW, displayH);
            ctx.save();
            ctx.translate(displayW / 2, displayH / 2);
            ctx.rotate(Math.PI); // 180åº¦
            ctx.drawImage(img, -displayW / 2, -displayH / 2, displayW, displayH);
            ctx.restore();

            canvasEl.style.display = 'block';
            const fallback = document.getElementById('chatFabFallback');
            if (fallback) fallback.style.display = 'none';

            if (callback) callback(canvasEl);
        };
        img.onerror = function () {
            console.log('å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨fallback');
        };
        img.src = srcUrl;
    }

    // ä¸ºèŠå¤©çª—å£å¤´éƒ¨ç”Ÿæˆæ—‹è½¬å¤´åƒ
    function buildHeaderRotatedAvatar(srcUrl) {
        const headerAvatar = document.getElementById('chatHeaderAvatar');

        const c = document.createElement('canvas');
        c.width  = 40;
        c.height = 40;
        c.style.cssText = 'width:40px;height:40px;border-radius:50%;';

        rotateImage(srcUrl, c, function () {
            headerAvatar.innerHTML = '';
            headerAvatar.appendChild(c);
        });
    }

    // ç”Ÿæˆæ¶ˆæ¯æ°”æ³¡ç”¨çš„æ—‹è½¬å¤´åƒï¼ˆ34Ã—34ï¼‰- åŒæ­¥è¿”å›å ä½ï¼Œå¼‚æ­¥æ›´æ–°
    function makeMsgRotatedCanvas(srcUrl, callback) {
        // ç«‹å³åˆ›å»ºå ä½å…ƒç´ 
        const placeholder = document.createElement('div');
        placeholder.className = 'msg-avatar ai-avatar';
        placeholder.textContent = 'ğŸ™ƒ';
        placeholder.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:1rem;width:34px;height:34px;border-radius:50%;flex-shrink:0;';
        
        // ç«‹å³è¿”å›å ä½ç¬¦
        callback(placeholder);

        // å¼‚æ­¥åŠ è½½çœŸå®å¤´åƒ
        const c = document.createElement('canvas');
        c.width  = 34;
        c.height = 34;
        c.className = 'msg-avatar ai-avatar';
        c.style.cssText = 'border-radius:50%;flex-shrink:0;width:34px;height:34px;';

        rotateImage(srcUrl, c, function () {
            // å¦‚æœå ä½ç¬¦è¿˜åœ¨DOMä¸­ï¼Œåˆ™æ›¿æ¢
            if (placeholder.parentNode) {
                placeholder.parentNode.replaceChild(c, placeholder);
            }
        });
    }

    // =============================================
    //  åˆå§‹åŒ–æ—‹è½¬å¤´åƒ
    // =============================================
    function initRotatedAvatars() {
        if (!avatarPath) return;

        // FAB æŒ‰é’®
        const fabCanvas = document.getElementById('chatFabCanvas');
        if (fabCanvas) rotateImage(avatarPath, fabCanvas);

        // å¤´éƒ¨å¤´åƒ
        buildHeaderRotatedAvatar(avatarPath);

        // æ›´æ–°å¤´éƒ¨åå­—
        const nameEl = document.getElementById('chatHeaderName');
        if (nameEl) nameEl.textContent = aiName;
    }

    // =============================================
    //  æ‰“å­—æœºæ•ˆæœ
    // =============================================
    function typewriter(el, text, speed, onDone) {
        speed = speed || 28;
        let i = 0;
        el.textContent = '';
        const timer = setInterval(function () {
            if (i < text.length) {
                const ch = text[i];
                if (ch === '\n') {
                    el.appendChild(document.createElement('br'));
                } else {
                    el.appendChild(document.createTextNode(ch));
                }
                i++;
                scrollChatToBottom();
            } else {
                clearInterval(timer);
                if (onDone) onDone();
            }
        }, speed);
    }

    // =============================================
    //  è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²
    // =============================================
    function getNowTime() {
        const d = new Date();
        return d.getHours().toString().padStart(2, '0') + ':' +
               d.getMinutes().toString().padStart(2, '0');
    }

    // =============================================
    //  æ»šåŠ¨åˆ°åº•éƒ¨
    // =============================================
    function scrollChatToBottom() {
        const msgs = document.getElementById('chatMessages');
        if (msgs) msgs.scrollTop = msgs.scrollHeight;
    }

    // =============================================
    //  æ„å»º AI å¤´åƒèŠ‚ç‚¹ï¼ˆåŒæ­¥è¿”å›å ä½ï¼Œå¼‚æ­¥æ›´æ–°ï¼‰
    // =============================================
    function buildAiAvatarNode(callback) {
        // ç«‹å³åˆ›å»ºå ä½å…ƒç´ 
        const placeholder = document.createElement('div');
        placeholder.className = 'msg-avatar ai-avatar';
        placeholder.textContent = 'ğŸ™ƒ';
        placeholder.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:1rem;width:34px;height:34px;border-radius:50%;flex-shrink:0;';
        
        // ç«‹å³è¿”å›å ä½ç¬¦
        callback(placeholder);
        
        // å¼‚æ­¥åŠ è½½çœŸå®å¤´åƒ
        if (avatarPath) {
            makeMsgRotatedCanvas(avatarPath, function(realAvatar) {
                // å¦‚æœå ä½ç¬¦è¿˜åœ¨DOMä¸­ï¼Œåˆ™æ›¿æ¢
                if (placeholder.parentNode) {
                    placeholder.parentNode.replaceChild(realAvatar, placeholder);
                }
            });
        }
    }

    // =============================================
    //  æ„å»ºç”¨æˆ·å¤´åƒèŠ‚ç‚¹ï¼ˆåŒæ­¥è¿”å›å ä½ï¼Œå¼‚æ­¥æ›´æ–°ï¼‰
    // =============================================
    function buildUserAvatarNode(callback) {
        // ç«‹å³åˆ›å»ºå ä½å…ƒç´ 
        const placeholder = document.createElement('div');
        placeholder.className = 'msg-avatar user-avatar';
        placeholder.textContent = userName ? userName[0] : 'æˆ‘';
        placeholder.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:1rem;width:34px;height:34px;border-radius:50%;flex-shrink:0;';
        
        // ç«‹å³è¿”å›å ä½ç¬¦
        callback(placeholder);
        
        // å¼‚æ­¥åŠ è½½çœŸå®å¤´åƒ
        if (avatarPath) {
            const img = new Image();
            img.onload = function() {
                const realAvatar = document.createElement('div');
                realAvatar.className = 'msg-avatar user-avatar';
                realAvatar.style.cssText = 'width:34px;height:34px;border-radius:50%;overflow:hidden;flex-shrink:0;';
                
                const imgElement = document.createElement('img');
                imgElement.src = avatarPath;
                imgElement.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                realAvatar.appendChild(imgElement);
                
                if (placeholder.parentNode) {
                    placeholder.parentNode.replaceChild(realAvatar, placeholder);
                }
            };
            img.onerror = function() {
                // åŠ è½½å¤±è´¥æ—¶ä¿æŒå ä½ç¬¦å³å¯
            };
            img.src = avatarPath;
        }
    }

    // =============================================
    //  æ·»åŠ  AI æ°”æ³¡
    // =============================================
    function appendAiBubble(callback) {
        buildAiAvatarNode(function (avatarNode) {
            const container = document.getElementById('chatMessages');
            const row    = document.createElement('div');
            row.className = 'chat-msg ai-msg';

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble ai-bubble';

            const timeEl = document.createElement('span');
            timeEl.className = 'msg-time';
            timeEl.textContent = getNowTime();

            const p = document.createElement('p');
            bubble.appendChild(p);
            bubble.appendChild(timeEl);

            row.appendChild(avatarNode);
            row.appendChild(bubble);
            container.appendChild(row);
            scrollChatToBottom();

            if (callback) callback(p);
        });
    }

    // =============================================
    //  æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    // =============================================
    function appendUserMessage(text) {
        buildUserAvatarNode(function (avatarNode) {
            const container = document.getElementById('chatMessages');
            const row    = document.createElement('div');
            row.className = 'chat-msg user-msg';

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble user-bubble';

            const p = document.createElement('p');
            text.split('\n').forEach(function (line, idx) {
                if (idx > 0) p.appendChild(document.createElement('br'));
                p.appendChild(document.createTextNode(line));
            });

            const timeEl = document.createElement('span');
            timeEl.className = 'msg-time';
            timeEl.textContent = getNowTime();

            bubble.appendChild(p);
            bubble.appendChild(timeEl);

            row.appendChild(bubble);
            row.appendChild(avatarNode);
            container.appendChild(row);
            scrollChatToBottom();
        });
    }

    // =============================================
    //  æ˜¾ç¤ºã€Œæ€è€ƒä¸­ã€æ°”æ³¡
    // =============================================
    function showThinking() {
        // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ€è€ƒæ°”æ³¡
        hideThinking();
        
        buildAiAvatarNode(function (avatarNode) {
            const container = document.getElementById('chatMessages');
            const row = document.createElement('div');
            row.className = 'chat-msg ai-msg';
            row.id = 'thinkingBubble';

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble ai-bubble thinking-bubble';
            bubble.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';

            row.appendChild(avatarNode);
            row.appendChild(bubble);
            container.appendChild(row);
            scrollChatToBottom();
        });
    }

    function hideThinking() {
        const el = document.getElementById('thinkingBubble');
        if (el) el.remove();
    }

    // =============================================
    //  æ¬¢è¿è¯­
    // =============================================
    function showWelcomeMessage() {
        const welcomeText = `ä½ å¥½ ${userName}ï¼Œæˆ‘æ˜¯ç›—orå€’ç‰ˆ${userName}ï¼Œå¾ˆé«˜å…´å’Œä½ èŠå¤©ã€‚`;
        appendAiBubble(function (p) {
            typewriter(p, welcomeText, 45);
        });
    }

    // =============================================
    //  æ¸…ç©ºå¹¶é‡ç½®å¯¹è¯
    // =============================================
    function clearAndResetChat() {
        document.getElementById('chatMessages').innerHTML = '';
        chatConversationId = null;
        showWelcomeMessage();
    }
    window.clearAndResetChat = clearAndResetChat;

    // =============================================
    //  FAB æ‹–æ‹½é€»è¾‘
    // =============================================
    (function initDrag() {
        const fab = document.getElementById('chatFab');
        const WIN_W = 360;
        const WIN_H = 520;
        const FAB_SIZE = 62;
        const MARGIN = 12;

        let dragging = false;
        let startX, startY, origLeft, origTop;
        let fabLeft = null;
        let fabTop  = null;

        function getInitialPos() {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            return {
                left: vw - FAB_SIZE - 32,
                top:  vh - FAB_SIZE - 32
            };
        }

        function clampFab(left, top) {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            left = Math.max(MARGIN, Math.min(left, vw - FAB_SIZE - MARGIN));
            top  = Math.max(MARGIN, Math.min(top,  vh - FAB_SIZE - MARGIN));
            return { left, top };
        }

        function applyFabPos(left, top) {
            fab.style.right  = 'auto';
            fab.style.bottom = 'auto';
            fab.style.left   = left + 'px';
            fab.style.top    = top  + 'px';
            fabLeft = left;
            fabTop  = top;
        }

        function getWindowPos(fabL, fabT) {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const GAP = 10;

            let wLeft = fabL + FAB_SIZE / 2 - WIN_W + 16;
            let wTop  = fabT - WIN_H - GAP;

            wLeft = Math.max(MARGIN, Math.min(wLeft, vw - WIN_W - MARGIN));
            if (wTop < MARGIN) {
                wTop = fabT + FAB_SIZE + GAP;
            }
            if (wTop + WIN_H > vh - MARGIN) {
                wTop = Math.max(MARGIN, vh - WIN_H - MARGIN);
            }

            return { left: wLeft, top: wTop };
        }

        function updateWindowPos() {
            if (fabLeft === null) return;
            const win = document.getElementById('chatWindow');
            const pos = getWindowPos(fabLeft, fabTop);
            win.style.right  = 'auto';
            win.style.bottom = 'auto';
            win.style.left   = pos.left + 'px';
            win.style.top    = pos.top  + 'px';
        }

        function onPointerDown(e) {
            if (e.type === 'mousedown' && e.button !== 0) return;

            if (fabLeft === null) {
                const pos = getInitialPos();
                fabLeft = pos.left;
                fabTop  = pos.top;
                applyFabPos(fabLeft, fabTop);
            }

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            dragging = false;
            startX   = clientX;
            startY   = clientY;
            origLeft = fabLeft;
            origTop  = fabTop;

            fab._pointerMoved = false;

            document.addEventListener('mousemove', onPointerMove);
            document.addEventListener('mouseup',   onPointerUp);
            document.addEventListener('touchmove', onPointerMove, { passive: false });
            document.addEventListener('touchend',  onPointerUp);
        }

        function onPointerMove(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - startX;
            const dy = clientY - startY;

            if (!dragging && Math.sqrt(dx*dx + dy*dy) < 5) return;

            dragging = true;
            fab._pointerMoved = true;
            if (e.cancelable) e.preventDefault();

            const clamped = clampFab(origLeft + dx, origTop + dy);
            applyFabPos(clamped.left, clamped.top);

            if (chatOpen) updateWindowPos();
        }

        function onPointerUp(e) {
            document.removeEventListener('mousemove', onPointerMove);
            document.removeEventListener('mouseup',   onPointerUp);
            document.removeEventListener('touchmove', onPointerMove);
            document.removeEventListener('touchend',  onPointerUp);

            if (!dragging) {
                toggleChatWindow();
            } else {
                const vw = window.innerWidth;
                const midX = fabLeft + FAB_SIZE / 2;
                const snapLeft = midX < vw / 2 ? MARGIN : vw - FAB_SIZE - MARGIN;

                fab.style.transition = 'left 0.3s cubic-bezier(.34,1.4,.64,1), top 0.2s ease';
                applyFabPos(snapLeft, fabTop);
                if (chatOpen) {
                    setTimeout(updateWindowPos, 320);
                }
                setTimeout(function () {
                    fab.style.transition = '';
                }, 400);
            }

            dragging = false;
        }

        fab.addEventListener('mousedown',  onPointerDown);
        fab.addEventListener('touchstart', onPointerDown, { passive: true });
        fab.removeAttribute('onclick');

        window.addEventListener('resize', function () {
            if (fabLeft !== null) {
                const clamped = clampFab(fabLeft, fabTop);
                applyFabPos(clamped.left, clamped.top);
                if (chatOpen) updateWindowPos();
            }
        });

        window._chatUpdateWindowPos = updateWindowPos;
    })();

    // =============================================
    //  åˆ‡æ¢èŠå¤©çª—å£
    // =============================================
    window.toggleChatWindow = function () {
        chatOpen = !chatOpen;
        const win     = document.getElementById('chatWindow');
        const fab     = document.getElementById('chatFab');
        const overlay = document.getElementById('chatOverlay');

        if (chatOpen) {
            if (window._chatUpdateWindowPos) window._chatUpdateWindowPos();

            document.getElementById('chatMessages').innerHTML = '';
            chatConversationId = null;
            showWelcomeMessage();

            win.classList.add('chat-window--open');
            fab.style.opacity = '0';
            fab.style.pointerEvents = 'none';
            fab.style.visibility = 'hidden';
            
            overlay.classList.add('chat-overlay--show');
            
            setTimeout(function () {
                document.getElementById('chatInput').focus();
            }, 300);
        } else {
            win.classList.remove('chat-window--open');
            fab.style.opacity = '';
            fab.style.pointerEvents = '';
            fab.style.visibility = '';
            
            overlay.classList.remove('chat-overlay--show');
        }
    };

    // =============================================
    //  é”®ç›˜ï¼šEnter å‘é€
    // =============================================
    window.handleChatKeydown = function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    };

    // =============================================
    //  è¾“å…¥æ¡†è‡ªåŠ¨é«˜åº¦
    // =============================================
    window.autoResizeChatInput = function (el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    };

    // =============================================
    //  çŠ¶æ€æ æ–‡å­—
    // =============================================
    function setStatus(html) {
        const el = document.getElementById('chatStatus');
        if (el) el.innerHTML = html;
    }

    // =============================================
    //  å‘é€æ¶ˆæ¯
    // =============================================
    window.sendChatMessage = async function () {
        if (chatLoading) return;

        const input = document.getElementById('chatInput');
        const text  = input.value.trim();
        if (!text) return;

        input.value = '';
        input.style.height = 'auto';

        // ç«‹å³ç¦ç”¨å‘é€æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        chatLoading = true;
        document.getElementById('chatSendBtn').disabled = true;
        document.getElementById('chatSendBtn').style.opacity = '0.5';
        setStatus('<span class="status-dot thinking"></span> æ€è€ƒä¸­...');

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        appendUserMessage(text);
        
        // æ˜¾ç¤ºæ€è€ƒæ°”æ³¡ï¼ˆå†…éƒ¨ä¼šå…ˆæ¸…ç†æ—§çš„ï¼‰
        showThinking();

        try {
            const resp = await fetch('/chat_api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: text,
                    conversation_id: chatConversationId
                })
            });
            
            // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œå…ˆç§»é™¤æ€è€ƒæ°”æ³¡
            hideThinking();
            
            const data = await resp.json();

            if (data.success) {
                if (data.conversation_id) chatConversationId = data.conversation_id;
                appendAiBubble(function (p) {
                    typewriter(p, data.reply || 'ï¼ˆç©ºå›å¤ï¼‰');
                });
            } else {
                appendAiBubble(function (p) {
                    typewriter(p, 'æŠ±æ­‰ï¼Œå‡ºäº†ç‚¹é—®é¢˜ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                });
            }
        } catch (err) {
            // ç¡®ä¿åœ¨é”™è¯¯æ—¶ä¹Ÿç§»é™¤æ€è€ƒæ°”æ³¡
            hideThinking();
            appendAiBubble(function (p) {
                typewriter(p, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯• ğŸ˜¢');
            });
        } finally {
            chatLoading = false;
            document.getElementById('chatSendBtn').disabled = false;
            document.getElementById('chatSendBtn').style.opacity = '1';
            setStatus('<span class="status-dot"></span> åœ¨çº¿');
            
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹å†è·å–ç„¦ç‚¹ï¼Œé¿å…ä¸ç‚¹å‡»äº‹ä»¶å†²çª
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 50);
        }
    };

    // =============================================
    //  é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ—‹è½¬å¤´åƒ
    // =============================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRotatedAvatars);
    } else {
        initRotatedAvatars();
    }

})();
</script>