{# ä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™ JS #}
{% if current_user and current_user.avatar_path %}
<script>
    window._userAvatarPath = "/{{ current_user.avatar_path }}";
    window._userName = "{{ current_user.username | e }}";
</script>
{% else %}
<script>
    window._userAvatarPath = null;
    window._userName = "è®¿å®¢";
</script>
{% endif %}

<!-- ========== æ‚¬æµ®æŒ‰é’® FAB ========== -->
<button class="chat-fab" id="chatFab" title="å’Œ AI èŠå¤©">
    <!-- åƒç´ åŒ–å¤´åƒç”»å¸ƒï¼ŒJS æ¸²æŸ“åæ›¿æ¢ -->
    <canvas id="chatFabCanvas" width="62" height="62" style="display:none; border-radius:50%;"></canvas>
    <!-- åŠ è½½ä¸­çš„ç²‰è‰²é»˜è®¤å›¾æ ‡ -->
    <span class="chat-fab-icon" id="chatFabFallback">âœ¨</span>
</button>

<!-- ========== èŠå¤©çª—å£ ========== -->
<div class="chat-window" id="chatWindow">

    <!-- çª—å£å¤´éƒ¨ -->
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="chat-header-avatar" id="chatHeaderAvatar">
                <!-- åƒç´ åŒ–å¤´åƒç”± JS æ’å…¥ canvas -->
                <span class="chat-header-avatar-fallback">âœ¨</span>
            </div>
            <div class="chat-header-info">
                <span class="chat-header-name" id="chatHeaderName">AI å°åŠ©æ‰‹</span>
                <span class="chat-header-status" id="chatStatus">
                    <span class="status-dot"></span> åœ¨çº¿
                </span>
            </div>
        </div>
        <div class="chat-header-actions">
            <button class="chat-action-btn" onclick="clearAndResetChat()" title="æ¸…ç©ºå¯¹è¯">ğŸ—‘ï¸</button>
            <button class="chat-action-btn" onclick="toggleChatWindow()" title="å…³é—­">âœ•</button>
        </div>
    </div>

    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div class="chat-messages" id="chatMessages"></div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input-area">
        <div class="chat-input-wrapper">
            <textarea
                id="chatInput"
                class="chat-input"
                placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€..."
                rows="1"
                onkeydown="handleChatKeydown(event)"
                oninput="autoResizeChatInput(this)"
            ></textarea>
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- é®ç½©å±‚ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
<div class="chat-overlay" id="chatOverlay" onclick="toggleChatWindow()"></div>

<script>
(function () {
    // =============================================
    //  å…¨å±€çŠ¶æ€
    // =============================================
    let chatOpen          = false;
    let chatLoading       = false;
    let chatConversationId = null;

    const userName    = window._userName    || 'è®¿å®¢';
    const avatarPath  = window._userAvatarPath || null;

    // AI åç§°ï¼šç”¨æˆ·å + (AIé™å®š)
    const aiName = userName + 'ï¼ˆAIé™å®šï¼‰';

    // =============================================
    //  è½»é‡åƒç´ åŒ–å¤„ç†
    //  ä¿ç•™å¤´åƒå¯è¯†åˆ«åº¦ï¼Œæ·»åŠ è½»å¾®çš„åƒç´ é£æ ¼
    //  ä½¿ç”¨è¾ƒå°çš„åƒç´ å—å’Œæ··åˆé‡‡æ ·ï¼Œè®©äººèƒ½è®¤å‡ºæ˜¯è‡ªå·±
    // =============================================
    function lightPixelate(srcUrl, canvasEl, options, callback) {
        // é»˜è®¤å‚æ•°ï¼šå°åƒç´ å—ï¼Œä¿ç•™ç»†èŠ‚
        const pixelSize = options.pixelSize || 4;  // æ›´å°çš„åƒç´ å—ï¼ˆ4pxï¼‰
        const w = canvasEl.width;
        const h = canvasEl.height;
        const ctx = canvasEl.getContext('2d');

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function () {
            // è®¡ç®—ç½‘æ ¼å°ºå¯¸ - ä½¿ç”¨æ›´ç²¾ç»†çš„ç½‘æ ¼
            const cols = Math.ceil(w / pixelSize);
            const rows = Math.ceil(h / pixelSize);

            // ç¬¬ä¸€æ­¥ï¼šç»˜åˆ¶åŸå§‹å›¾åƒåˆ°ç¦»å±canvasï¼ˆä¿æŒå¹³æ»‘ï¼Œä¿ç•™ç»†èŠ‚ï¼‰
            const offCanvas = document.createElement('canvas');
            offCanvas.width = w;
            offCanvas.height = h;
            const offCtx = offCanvas.getContext('2d');
            offCtx.drawImage(img, 0, 0, w, h);

            // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºåƒç´ åŒ–æ•ˆæœï¼Œä½†ä¿ç•™æ›´å¤šåŸå§‹è‰²å½©
            ctx.clearRect(0, 0, w, h);
            
            // ä½¿ç”¨åŒçº¿æ€§é‡‡æ ·ï¼Œè®©åƒç´ å—ä¹‹é—´æœ‰å¹³æ»‘è¿‡æ¸¡ï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬çš„é©¬èµ›å…‹
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = col * pixelSize;
                    const y = row * pixelSize;
                    
                    // è·å–è¯¥åŒºåŸŸçš„ä¸­å¿ƒç‚¹é¢œè‰²ï¼Œè€Œä¸æ˜¯å•ç‚¹é‡‡æ ·
                    const centerX = Math.min(x + pixelSize/2, w - 1);
                    const centerY = Math.min(y + pixelSize/2, h - 1);
                    
                    // è¯»å–åƒç´ é¢œè‰²
                    const pixel = offCtx.getImageData(centerX, centerY, 1, 1).data;
                    const r = pixel[0];
                    const g = pixel[1];
                    const b = pixel[2];
                    const a = pixel[3];

                    if (a < 30) continue;

                    // ä½¿ç”¨è½»å¾®çš„åœ†è§’ï¼Œè®©åƒç´ å—ä¸é‚£ä¹ˆç”Ÿç¡¬
                    ctx.fillStyle = `rgba(${r},${g},${b},${a/255})`;
                    
                    // å¦‚æœåƒç´ å—å¾ˆå°ï¼Œå°±ç”¨çŸ©å½¢ï¼›å¦‚æœåƒç´ å—ç¨å¤§ï¼Œå¯ä»¥åŠ è½»å¾®åœ†è§’
                    if (pixelSize <= 4) {
                        ctx.fillRect(x, y, pixelSize, pixelSize);
                    } else {
                        // è½»å¾®çš„åœ†è§’ï¼Œè®©è§†è§‰æ›´æŸ”å’Œ
                        const radius = pixelSize * 0.15;
                        ctx.beginPath();
                        ctx.roundRect(x, y, pixelSize, pixelSize, radius);
                        ctx.fill();
                    }
                }
            }

            // å¯é€‰ï¼šæ·»åŠ è½»å¾®çš„é”åŒ–æ•ˆæœï¼Œè®©å¤´åƒæ›´æ¸…æ™°
            if (options.sharpen) {
                const imageData = ctx.getImageData(0, 0, w, h);
                const data = imageData.data;
                // ç®€å•çš„å¯¹æ¯”åº¦å¢å¼º
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = Math.min(255, data[i] * 1.05);     // R
                    data[i+1] = Math.min(255, data[i+1] * 1.05); // G
                    data[i+2] = Math.min(255, data[i+2] * 1.05); // B
                }
                ctx.putImageData(imageData, 0, 0);
            }

            // æ˜¾ç¤ºç”»å¸ƒï¼Œéšè— fallback
            canvasEl.style.display = 'block';
            const fallback = document.getElementById('chatFabFallback');
            if (fallback) fallback.style.display = 'none';

            if (callback) callback(canvasEl);
        };
        img.onerror = function () { 
            console.log('å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨fallback');
        };
        img.src = srcUrl;
    }

    // æ·»åŠ  roundRect æ–¹æ³•ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.moveTo(x + r, y);
            this.lineTo(x + w - r, y);
            this.quadraticCurveTo(x + w, y, x + w, y + r);
            this.lineTo(x + w, y + h - r);
            this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            this.lineTo(x + r, y + h);
            this.quadraticCurveTo(x, y + h, x, y + h - r);
            this.lineTo(x, y + r);
            this.quadraticCurveTo(x, y, x + r, y);
            return this;
        };
    }

    // ä¸ºèŠå¤©çª—å£å¤´éƒ¨ç”Ÿæˆè½»é‡åƒç´ åŒ– canvas
    function buildHeaderPixelAvatar(srcUrl) {
        const headerAvatar = document.getElementById('chatHeaderAvatar');

        const c = document.createElement('canvas');
        c.width  = 40;
        c.height = 40;
        c.style.cssText = 'width:40px;height:40px;border-radius:50%;';

        lightPixelate(srcUrl, c, { pixelSize: 3, sharpen: true }, function () {
            headerAvatar.innerHTML = '';
            headerAvatar.appendChild(c);
        });
    }

    // ç”Ÿæˆæ¶ˆæ¯æ°”æ³¡ç”¨çš„è½»é‡åƒç´ åŒ– canvasï¼ˆ34Ã—34ï¼‰
    function makeMsgPixelCanvas(srcUrl, callback) {
        const c = document.createElement('canvas');
        c.width  = 34;
        c.height = 34;
        c.className = 'msg-avatar ai-avatar';
        c.style.cssText = 'border-radius:50%;flex-shrink:0;';

        lightPixelate(srcUrl, c, { pixelSize: 3, sharpen: true }, function () {
            if (callback) callback(c);
        });

        // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥çš„å¤„ç†
        const img = new Image();
        img.onerror = function () {
            if (callback) {
                const d = document.createElement('div');
                d.className = 'msg-avatar ai-avatar';
                d.textContent = 'âœ¨';
                d.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:1rem;';
                callback(d);
            }
        };
    }

    // =============================================
    //  åˆå§‹åŒ–åƒç´ åŒ–å¤´åƒï¼ˆé¡µé¢åŠ è½½åæ‰§è¡Œï¼‰
    // =============================================
    function initPixelAvatars() {
        if (!avatarPath) return;

        // FAB æŒ‰é’®ï¼ˆä½¿ç”¨æ›´å°çš„åƒç´ å—ï¼Œä¿ç•™ç»†èŠ‚ï¼‰
        const fabCanvas = document.getElementById('chatFabCanvas');
        if (fabCanvas) lightPixelate(avatarPath, fabCanvas, { pixelSize: 4, sharpen: true });

        // å¤´éƒ¨å¤´åƒï¼ˆpixelSize=3ï¼Œæ›´ç²¾ç»†ï¼‰
        buildHeaderPixelAvatar(avatarPath);

        // æ›´æ–°å¤´éƒ¨åå­—
        const nameEl = document.getElementById('chatHeaderName');
        if (nameEl) nameEl.textContent = aiName;
    }

    // =============================================
    //  æ‰“å­—æœºæ•ˆæœ
    // =============================================
    function typewriter(el, text, speed, onDone) {
        speed = speed || 28;
        let i = 0;
        el.textContent = '';
        const timer = setInterval(function () {
            const ch = text[i];
            if (ch === '\n') {
                el.appendChild(document.createElement('br'));
            } else {
                el.appendChild(document.createTextNode(ch));
            }
            i++;
            scrollChatToBottom();
            if (i >= text.length) {
                clearInterval(timer);
                if (onDone) onDone();
            }
        }, speed);
    }

    // =============================================
    //  è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²
    // =============================================
    function getNowTime() {
        const d = new Date();
        return d.getHours().toString().padStart(2, '0') + ':' +
               d.getMinutes().toString().padStart(2, '0');
    }

    // =============================================
    //  æ»šåŠ¨åˆ°åº•éƒ¨
    // =============================================
    function scrollChatToBottom() {
        const msgs = document.getElementById('chatMessages');
        if (msgs) msgs.scrollTop = msgs.scrollHeight;
    }

    // =============================================
    //  æ„å»ºåƒç´ åŒ– AI å¤´åƒèŠ‚ç‚¹ï¼ˆå¼‚æ­¥ï¼‰
    // =============================================
    function buildAiAvatarNode(callback) {
        if (avatarPath) {
            makeMsgPixelCanvas(avatarPath, callback);
        } else {
            const d = document.createElement('div');
            d.className = 'msg-avatar ai-avatar';
            d.textContent = 'âœ¨';
            d.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:1rem;';
            callback(d);
        }
    }

    // =============================================
    //  æ„å»ºç”¨æˆ·å¤´åƒèŠ‚ç‚¹
    // =============================================
    function buildUserAvatarNode() {
        const el = document.createElement('div');
        el.className = 'msg-avatar user-avatar';
        if (avatarPath) {
            const img = document.createElement('img');
            img.src   = avatarPath;
            img.alt   = userName;
            img.onerror = function () {
                el.removeChild(img);
                el.textContent = userName ? userName[0] : 'æˆ‘';
            };
            el.appendChild(img);
        } else {
            el.textContent = userName ? userName[0] : 'æˆ‘';
        }
        return el;
    }

    // =============================================
    //  æ·»åŠ  AI æ°”æ³¡
    // =============================================
    function appendAiBubble(callback) {
        buildAiAvatarNode(function (avatarNode) {
            const container = document.getElementById('chatMessages');
            const row    = document.createElement('div');
            row.className = 'chat-msg ai-msg';

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble ai-bubble';

            const timeEl = document.createElement('span');
            timeEl.className = 'msg-time';
            timeEl.textContent = getNowTime();

            const p = document.createElement('p');
            bubble.appendChild(p);
            bubble.appendChild(timeEl);

            row.appendChild(avatarNode);
            row.appendChild(bubble);
            container.appendChild(row);
            scrollChatToBottom();

            if (callback) callback(p);
        });
    }

    // =============================================
    //  æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    // =============================================
    function appendUserMessage(text) {
        const container = document.getElementById('chatMessages');
        const row    = document.createElement('div');
        row.className = 'chat-msg user-msg';

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble user-bubble';

        const p = document.createElement('p');
        text.split('\n').forEach(function (line, idx) {
            if (idx > 0) p.appendChild(document.createElement('br'));
            p.appendChild(document.createTextNode(line));
        });

        const timeEl = document.createElement('span');
        timeEl.className = 'msg-time';
        timeEl.textContent = getNowTime();

        bubble.appendChild(p);
        bubble.appendChild(timeEl);

        const avatarNode = buildUserAvatarNode();

        row.appendChild(bubble);
        row.appendChild(avatarNode);
        container.appendChild(row);
        scrollChatToBottom();
    }

    // =============================================
    //  æ˜¾ç¤ºã€Œæ€è€ƒä¸­ã€æ°”æ³¡
    // =============================================
    function showThinking() {
        buildAiAvatarNode(function (avatarNode) {
            const container = document.getElementById('chatMessages');
            const row = document.createElement('div');
            row.className = 'chat-msg ai-msg';
            row.id = 'thinkingBubble';

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble ai-bubble thinking-bubble';
            bubble.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';

            row.appendChild(avatarNode);
            row.appendChild(bubble);
            container.appendChild(row);
            scrollChatToBottom();
        });
    }

    function hideThinking() {
        const el = document.getElementById('thinkingBubble');
        if (el) el.remove();
    }

    // =============================================
    //  æ¬¢è¿è¯­ï¼šæ‰“å­—æœºæ˜¾ç¤º
    // =============================================
    function showWelcomeMessage() {
        const welcomeText = `ä½ å¥½ ${userName}ï¼Œæˆ‘æ˜¯ ${aiName}ï¼Œå¾ˆé«˜å…´å’Œä½ èŠå¤©ã€‚`;
        appendAiBubble(function (p) {
            typewriter(p, welcomeText, 45);
        });
    }

    // =============================================
    //  æ¸…ç©ºå¹¶é‡ç½®å¯¹è¯
    // =============================================
    function clearAndResetChat() {
        document.getElementById('chatMessages').innerHTML = '';
        chatConversationId = null;
        showWelcomeMessage();
    }
    window.clearAndResetChat = clearAndResetChat;

    // =============================================
    //  FAB æ‹–æ‹½é€»è¾‘
    //  æ”¯æŒé¼ æ ‡ & è§¦æ‘¸ï¼Œæ‹–æ‹½ç»“æŸåå¸é™„è¾¹ç¼˜
    //  å±•å¼€çª—å£æ—¶ç¡®ä¿å®Œæ•´æ˜¾ç¤ºåœ¨è§†å£å†…
    // =============================================
    (function initDrag() {
        const fab = document.getElementById('chatFab');
        const WIN_W = 360;
        const WIN_H = 520;
        const FAB_SIZE = 62;
        const MARGIN = 12; // æœ€å°è¾¹è·

        let dragging = false;
        let startX, startY, origLeft, origTop;
        // fab å½“å‰ä½ç½®ï¼ˆleft/top å½¢å¼ï¼Œåˆå§‹ä» fixed right/bottom æ¢ç®—ï¼‰
        let fabLeft = null;
        let fabTop  = null;

        function getInitialPos() {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            // å¯¹åº” CSS: bottom:32px right:32px
            return {
                left: vw - FAB_SIZE - 32,
                top:  vh - FAB_SIZE - 32
            };
        }

        function clampFab(left, top) {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            left = Math.max(MARGIN, Math.min(left, vw - FAB_SIZE - MARGIN));
            top  = Math.max(MARGIN, Math.min(top,  vh - FAB_SIZE - MARGIN));
            return { left, top };
        }

        function applyFabPos(left, top) {
            fab.style.right  = 'auto';
            fab.style.bottom = 'auto';
            fab.style.left   = left + 'px';
            fab.style.top    = top  + 'px';
            fabLeft = left;
            fabTop  = top;
        }

        // è®¡ç®—èŠå¤©çª—å£åº”æ˜¾ç¤ºçš„ä½ç½®ï¼ˆä¿è¯å®Œå…¨åœ¨è§†å£å†…ï¼‰
        function getWindowPos(fabL, fabT) {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const GAP = 10; // FAB ä¸çª—å£ä¹‹é—´çš„é—´éš™

            // å°è¯•åœ¨ FAB ä¸Šæ–¹åå·¦
            let wLeft = fabL + FAB_SIZE / 2 - WIN_W + 16;
            let wTop  = fabT - WIN_H - GAP;

            // æ¨ªå‘å¤¹ç´§
            wLeft = Math.max(MARGIN, Math.min(wLeft, vw - WIN_W - MARGIN));
            // çºµå‘ï¼šè‹¥ä¸Šæ–¹æ”¾ä¸ä¸‹å°±æ”¾ä¸‹æ–¹
            if (wTop < MARGIN) {
                wTop = fabT + FAB_SIZE + GAP;
            }
            // ä¸‹æ–¹ä¹Ÿæ”¾ä¸ä¸‹åˆ™è´´é¡¶
            if (wTop + WIN_H > vh - MARGIN) {
                wTop = Math.max(MARGIN, vh - WIN_H - MARGIN);
            }

            return { left: wLeft, top: wTop };
        }

        function updateWindowPos() {
            if (fabLeft === null) return;
            const win = document.getElementById('chatWindow');
            const pos = getWindowPos(fabLeft, fabTop);
            win.style.right  = 'auto';
            win.style.bottom = 'auto';
            win.style.left   = pos.left + 'px';
            win.style.top    = pos.top  + 'px';
        }

        function onPointerDown(e) {
            // åªå“åº”ä¸»æŒ‰é’®/å•æŒ‡
            if (e.type === 'mousedown' && e.button !== 0) return;

            // åˆå§‹åŒ–ä½ç½®
            if (fabLeft === null) {
                const pos = getInitialPos();
                fabLeft = pos.left;
                fabTop  = pos.top;
                applyFabPos(fabLeft, fabTop);
            }

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            dragging = false;
            startX   = clientX;
            startY   = clientY;
            origLeft = fabLeft;
            origTop  = fabTop;

            fab._pointerMoved = false;

            document.addEventListener('mousemove', onPointerMove);
            document.addEventListener('mouseup',   onPointerUp);
            document.addEventListener('touchmove', onPointerMove, { passive: false });
            document.addEventListener('touchend',  onPointerUp);
        }

        function onPointerMove(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - startX;
            const dy = clientY - startY;

            if (!dragging && Math.sqrt(dx*dx + dy*dy) < 5) return;

            dragging = true;
            fab._pointerMoved = true;
            if (e.cancelable) e.preventDefault();

            const clamped = clampFab(origLeft + dx, origTop + dy);
            applyFabPos(clamped.left, clamped.top);

            if (chatOpen) updateWindowPos();
        }

        function onPointerUp(e) {
            document.removeEventListener('mousemove', onPointerMove);
            document.removeEventListener('mouseup',   onPointerUp);
            document.removeEventListener('touchmove', onPointerMove);
            document.removeEventListener('touchend',  onPointerUp);

            if (!dragging) {
                // è§†ä¸ºç‚¹å‡»
                toggleChatWindow();
            } else {
                // å¸é™„åˆ°å·¦æˆ–å³è¾¹ç¼˜
                const vw = window.innerWidth;
                const midX = fabLeft + FAB_SIZE / 2;
                const snapLeft = midX < vw / 2
                    ? MARGIN
                    : vw - FAB_SIZE - MARGIN;

                // ä½¿ç”¨ CSS transition å®Œæˆå¸é™„åŠ¨ç”»
                fab.style.transition = 'left 0.3s cubic-bezier(.34,1.4,.64,1), top 0.2s ease';
                applyFabPos(snapLeft, fabTop);
                if (chatOpen) {
                    setTimeout(updateWindowPos, 320);
                }
                setTimeout(function () {
                    fab.style.transition = '';
                }, 400);
            }

            dragging = false;
        }

        fab.addEventListener('mousedown',  onPointerDown);
        fab.addEventListener('touchstart', onPointerDown, { passive: true });

        // é˜»æ­¢ onclick å†’æ³¡ï¼ˆæ”¹ç”¨ pointerUp åˆ¤æ–­ç‚¹å‡»ï¼‰
        fab.removeAttribute('onclick');

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°å¤¹ç´§ä½ç½®
        window.addEventListener('resize', function () {
            if (fabLeft !== null) {
                const clamped = clampFab(fabLeft, fabTop);
                applyFabPos(clamped.left, clamped.top);
                if (chatOpen) updateWindowPos();
            }
        });

        // å¯¹å¤–æš´éœ² updateWindowPos
        window._chatUpdateWindowPos = updateWindowPos;
    })();

    // =============================================
    //  åˆ‡æ¢èŠå¤©çª—å£
    // =============================================

window.toggleChatWindow = function () {
    chatOpen = !chatOpen;
    const win     = document.getElementById('chatWindow');
    const fab     = document.getElementById('chatFab');
    const overlay = document.getElementById('chatOverlay');

    if (chatOpen) {
        // å…ˆå®šä½çª—å£å†å±•å¼€ï¼ˆé¿å…é—ªçƒï¼‰
        if (window._chatUpdateWindowPos) window._chatUpdateWindowPos();

        // æ¸…ç©ºæ¶ˆæ¯ï¼Œé‡æ–°æ˜¾ç¤ºæ¬¢è¿è¯­
        document.getElementById('chatMessages').innerHTML = '';
        chatConversationId = null;
        showWelcomeMessage();

        win.classList.add('chat-window--open');
        // ç›´æ¥è®¾ç½®å†…è”æ ·å¼éšè—æŒ‰é’®ï¼ˆæœ€ä¿é™©çš„æ–¹å¼ï¼‰
        fab.style.opacity = '0';
        fab.style.pointerEvents = 'none';
        fab.style.visibility = 'hidden';
        
        overlay.classList.add('chat-overlay--show');
        
        setTimeout(function () {
            document.getElementById('chatInput').focus();
        }, 300);
    } else {
        win.classList.remove('chat-window--open');
        // æ¢å¤å†…è”æ ·å¼
        fab.style.opacity = '';
        fab.style.pointerEvents = '';
        fab.style.visibility = '';
        
        overlay.classList.remove('chat-overlay--show');
    }
};

    // =============================================
    //  é”®ç›˜ï¼šEnter å‘é€
    // =============================================
    window.handleChatKeydown = function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    };

    // =============================================
    //  è¾“å…¥æ¡†è‡ªåŠ¨é«˜åº¦
    // =============================================
    window.autoResizeChatInput = function (el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    };

    // =============================================
    //  çŠ¶æ€æ æ–‡å­—
    // =============================================
    function setStatus(html) {
        const el = document.getElementById('chatStatus');
        if (el) el.innerHTML = html;
    }

    // =============================================
    //  å‘é€æ¶ˆæ¯
    // =============================================
    window.sendChatMessage = async function () {
        if (chatLoading) return;

        const input = document.getElementById('chatInput');
        const text  = input.value.trim();
        if (!text) return;

        input.value = '';
        input.style.height = 'auto';

        chatLoading = true;
        document.getElementById('chatSendBtn').disabled = true;
        document.getElementById('chatSendBtn').style.opacity = '0.5';
        setStatus('<span class="status-dot thinking"></span> æ€è€ƒä¸­...');

        appendUserMessage(text);
        showThinking();

        try {
            const resp = await fetch('/chat_api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: text,
                    conversation_id: chatConversationId
                })
            });
            const data = await resp.json();
            hideThinking();

            if (data.success) {
                if (data.conversation_id) chatConversationId = data.conversation_id;
                appendAiBubble(function (p) {
                    typewriter(p, data.reply || 'ï¼ˆç©ºå›å¤ï¼‰');
                });
            } else {
                appendAiBubble(function (p) {
                    typewriter(p, 'æŠ±æ­‰ï¼Œå‡ºäº†ç‚¹é—®é¢˜ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                });
            }
        } catch (err) {
            hideThinking();
            appendAiBubble(function (p) {
                typewriter(p, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯• ğŸ˜¢');
            });
        } finally {
            chatLoading = false;
            document.getElementById('chatSendBtn').disabled = false;
            document.getElementById('chatSendBtn').style.opacity = '1';
            setStatus('<span class="status-dot"></span> åœ¨çº¿');
            document.getElementById('chatInput').focus();
        }
    };

    // =============================================
    //  é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åƒç´ åŒ–å¤´åƒ
    // =============================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPixelAvatars);
    } else {
        initPixelAvatars();
    }

})();
</script>